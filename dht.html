<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Temperature Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-bottom: 5px; }
    .data-row { margin: 10px 0; }
    button { margin-left: 10px; padding: 5px 10px; }
    #status {
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>ESP32 Temperature Dashboard</h2>

  <div class="data-row"><strong>Temperature:</strong> <span id="temp">—</span></div>
  <div class="data-row"><strong>Humidity:</strong> <span id="hum">—</span></div>

  <div class="data-row">
    <strong>Motor 1:</strong> <span id="relay1">—</span>
    <button id="btnM1On" onclick="setRelay(3, 1)">ON</button>
    <button id="btnM1Off" onclick="setRelay(3, 0)">OFF</button>
  </div>

  <div class="data-row">
    <strong>Motor 2:</strong> <span id="relay2">—</span>
    <button id="btnM2On" onclick="setRelay(4, 1)">ON</button>
    <button id="btnM2Off" onclick="setRelay(4, 0)">OFF</button>
  </div>

  <div class="data-row" id="lastUpdate">Last update: —</div>

  <div id="status"></div>

  <div id="chart" style="width:100%; height:500px;"></div>

  <script>
    const channelID = "3082785";
    const readAPI = "JRBASV8AOT1TXBJZ";
    const writeAPI = "CBZLR0Q1V6JUA2HS";

    let isCooldown = false; // to prevent rapid switching

    function showMessage(message, type = "success") {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = "block";
      setTimeout(() => {
        statusDiv.style.display = "none";
      }, 4000);
    }

    function setButtonsDisabled(disabled) {
      document.getElementById("btnM1On").disabled = disabled;
      document.getElementById("btnM1Off").disabled = disabled;
      document.getElementById("btnM2On").disabled = disabled;
      document.getElementById("btnM2Off").disabled = disabled;
    }

    async function setRelay(fieldNum, value) {
      if (isCooldown) {
        showMessage("Please wait before switching again.", "error");
        return;
      }

      isCooldown = true;
      setButtonsDisabled(true);

      try {
        // Fetch latest data first
        const resLatest = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${readAPI}`);
        if (!resLatest.ok) throw new Error(`Failed to fetch latest data: ${resLatest.status}`);

        const latestData = await resLatest.json();

        // Prepare all fields with current values, update only target relay field
        const fields = {
          field1: latestData.field1 || '',
          field2: latestData.field2 || '',
          field3: latestData.field3 || '0',
          field4: latestData.field4 || '0',
        };

        fields[`field${fieldNum}`] = value.toString();

        // Build update URL with all fields to preserve data
        const updateUrl = `https://api.thingspeak.com/update?api_key=${writeAPI}` +
          `&field1=${encodeURIComponent(fields.field1)}` +
          `&field2=${encodeURIComponent(fields.field2)}` +
          `&field3=${encodeURIComponent(fields.field3)}` +
          `&field4=${encodeURIComponent(fields.field4)}`;

        // Send update request
        const resUpdate = await fetch(updateUrl);
        if (resUpdate.ok) {
          const text = await resUpdate.text();
          if (text === '0') {
            showMessage("ThingSpeak update rejected (rate limit or invalid data)", "error");
          } else {
            showMessage(`Motor ${fieldNum - 2} switched ${value === 1 ? "ON" : "OFF"}`, "success");
            setTimeout(fetchLatest, 2000);
          }
        } else {
          showMessage(`Failed to send command: HTTP ${resUpdate.status}`, "error");
        }
      } catch (e) {
        console.error("Error setting relay:", e);
        showMessage("Network or API error switching relay: " + e.message, "error");
      }

      // Enforce 15 seconds cooldown before allowing next switch
      setTimeout(() => {
        isCooldown = false;
        setButtonsDisabled(false);
      }, 15000);
    }

    async function fetchLatest() {
      try {
        const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${readAPI}`);
        const data = await res.json();

        const temp = data.field1;
        const hum = data.field2;
        const relay1 = data.field3;
        const relay2 = data.field4;

        document.getElementById("temp").textContent = temp ? temp + " °C" : "—";
        document.getElementById("hum").textContent = hum ? hum + " %" : "—";
        document.getElementById("relay1").textContent = relay1 === "1" ? "ON" : "OFF";
        document.getElementById("relay2").textContent = relay2 === "1" ? "ON" : "OFF";

        const lastUpdateTime = new Date(data.created_at);
        const now = new Date();
        const minutesAgo = Math.floor((now - lastUpdateTime) / 60000);
        document.getElementById("lastUpdate").textContent = `Last update: ${minutesAgo} min ago`;
      } catch (e) {
        console.error("Error fetching data:", e);
        document.getElementById("temp").textContent = "Err";
        document.getElementById("hum").textContent = "Err";
        document.getElementById("relay1").textContent = "—";
        document.getElementById("relay2").textContent = "—";
        document.getElementById("lastUpdate").textContent = "Error fetching update";
        showMessage("Failed to load data", "error");
      }
    }

    async function plotGraph() {
      try {
        const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPI}&results=50`);
        const json = await res.json();
        const feeds = json.feeds;

        const times = feeds.map(feed => feed.created_at);
        const temps = feeds.map(feed => parseFloat(feed.field1));
        const hums = feeds.map(feed => parseFloat(feed.field2));

        const tempTrace = {
          x: times,
          y: temps,
          name: 'Temperature (°C)',
          mode: 'lines+markers',
          line: { color: 'red' }
        };

        const humTrace = {
          x: times,
          y: hums,
          name: 'Humidity (%)',
          mode: 'lines+markers',
          line: { color: 'blue' }
        };

        const layout = {
          title: 'Temperature & Humidity Over Time',
          xaxis: { title: 'Time' },
          yaxis: { title: 'Value' }
        };

        Plotly.newPlot('chart', [tempTrace, humTrace], layout);
      } catch (e) {
        console.error("Error loading graph:", e);
        showMessage("Failed to load graph", "error");
      }
    }

    // Initial load and periodic updates
    fetchLatest();
    plotGraph();
    setInterval(() => {
      fetchLatest();
      plotGraph();
    }, 30000);
  </script>
</body>
</html>
